# mgmt590-am-batch-pipeline
# Containerized batch pipeline using DockerHub and Pachyderm
## About this Repository
This repository contains the pipeline specifications and code for making batch pipelines for the 
larger [Hugging  Face Transformers](https://huggingface.co/models) based Question Answer model.  
## Purpose
This repository contains two pipelines. 
### Pipeline 1 : Pulls the data uploaded by a user in a google cloud storage in the form of CSVs . 
There CSVs contain a list of questions and contexts . It then processes the questions asked to fetch ansers using a defualt BERT model for question answering .
Answers fetched are then written to an output directory.
### Pipeline 2: Pushes the answers created by first pipeline to a PostGres database on google cloud. 
The goal of these batch pipelines is to act as data pipelines between the CLoud storage and the 
Cloud SQL database, where the answers generated by the pipeline is stored.
The pipelines automates the data storage process by acting as a non-real time data updation
link between the model and the database. 
Below is a high-level diagram to show how the pipelines fit in the overall framework:</br>

<img width="889" alt="3" src="https://user-images.githubusercontent.com/84465734/121768365-e02cd980-cb2b-11eb-9a6e-7776ff856d55.PNG">
### Pipeline 1 Operation:
##(insert pipeline 1 data flow chart here)
Based on the diagram its clear that this pipeline takes multiple .csv files as an input,
processes them using the available Hugging Face models and generates the respective answers as
an output.
### Pipeline 2 Operation: 
(insert pipeline 2 data flow chart here)

## Deploying these pipelines
### Prerequisites 
- Must have a valid account on dockerhub - 
- Must have a google cloud storage already set up 
- Must have access to pachyderm - https://hub.pachyderm.com/landing

### Below are the steps to deploy your pipelines via Pachyderm:
Once the above pre-requisites are confirmed ,checkout this repository and proceed as below:
### 1. Build and deploy the docker images to DockerHub
- Add secret DOCKERHUB_USERNAME = <Your dockerhub username> in github secrets
- Add secret DOCKERHUB_TOKEN = <Your dockerhub access> in github secrets 
- Change your <your-dockerhub-username>/<docker-imaeg-name> in  .github/workflows/main.yml
        - - name: Build and push
      run: |-
        cd pachyderm_01 && docker build -t <your-dockerhub-username>/<docker-imaeg-name>:${{  github.sha }} .
        docker push <your-dockerhub-username>/<docker-imaeg-name>:${{  github.sha }} && cd ../
        cd pachyderm_02 && docker build -t <your-dockerhub-username>/<docker-imaeg-name>:${{  github.sha }} .
        docker push <your-dockerhub-username>/<docker-imaeg-name>:${{  github.sha }}
### TODO : provide a ref link on how to fetch dockerhub access token and adding to secrets
### 2. Create pachyderm workspace
#### 2.1 Sign-in to Pachyderm
#### https://hub.pachyderm.com/landing
#### 2.2 Create a new workspace as shown below
   <img width="309" alt="1" src="https://user-images.githubusercontent.com/84465734/121768778-fb98e400-cb2d-11eb-91c4-46e1946636f2.PNG">
#### 2.3 Login to Pachyderm Cluster 
## TODO 
#### 2.4 Install pachctl on your machine
   The "pachctl" or pach control is a command line tool that you can use to interact with a Pachyderm cluster in your terminal. For a Debian based Linux 64-bit or Windows 10    or later running on WSL run the following code:
   ```
   curl -o /tmp/pachctl.deb -L https://github.com/pachyderm/pachyderm/releases/download/v1.13.2/pachctl_1.13.2_amd64.deb && sudo dpkg -i /tmp/pachctl.deb
   ```
   For macOS use the below command:
   ```
   brew tap pachyderm/tap && brew install pachyderm/tap/pachctl@1.13
   ```
   For all other Linux systems use below command:
   ```
   curl -o /tmp/pachctl.tar.gz -L https://github.com/pachyderm/pachyderm/releases/download/v1.13.2/pachctl_1.13.2_linux_amd64.tar.gz && tar -xvf /tmp/pachctl.tar.gz -C /tmp && sudo cp /tmp/pachctl_1.13.2_linux_amd64/pachctl /usr/local/bin
   ```
#### 4. Connect to your Pachyderm workspace
   Click "Connect" on your Pachyderm workspace and follow the below listed steps to connect to your workspace via the machine:
   
   <img width="306" alt="2" src="https://user-images.githubusercontent.com/84465734/121769024-50892a00-cb2f-11eb-8546-97b039618abb.PNG">
    
#### 5. Create a new pachctl repo using the below command
   ```
    pachctl create repo reponamehere
   ```
#### 6. Verify that the repo was created using the below command
```
    pachctl list repo
```
An output like below listing the new repo should be generated:
    
    <img width="309" alt="4" src="https://user-images.githubusercontent.com/84465734/121769279-b0cc9b80-cb30-11eb-9171-04baba75e032.PNG">
    
#### 7. Now add data to Pachyderm using the command like shown below
   ```
   pachctl put file images@master:liberty.png -f http://imgur.com/46Q8nDz.png
   ```
   Here "images" is the repo name and "masters" is the branch name, therefore those need to be changed appropriately. Similarly the link/path to the datais (which is the part    after -f) should be updated as well.
   
#### 8. Create your JSON pipeline spec like the one shown below for each of the two pipelines
  ```{
  "pipeline": {
    "name": "edges"
  },
  "description": "A pipeline that performs image edge detection by using the OpenCV library.",
  "input": {
    "pfs": {
      "glob": "/*",
      
      "repo": "images"
    }
  },
  "transform": {
    "cmd": [ "python3", "/edges.py" ],
    "image": "pachyderm/opencv"
  }
}
```
Refer to [this helpful tutorial](https://docs.pachyderm.com/latest/getting_started/beginner_tutorial/) to make your pipeline spec. 
#### 9. Create your pipeline 
Following is a template command to make your pipeline
 
```
pachctl create pipeline -f https://raw.githubusercontent.com/pachyderm/pachyderm/1.13.x/examples/opencv/edges.json
```
Make sure you insert the correct pipeline spec link.
 
(outputs after pipelines have ran to be put here)
